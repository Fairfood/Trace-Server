from fairtrace_v2.v2.products.constants import UNIT_KG
from fairtrace_v2.v2.products.models import Batch, Product
from fairtrace_v2.v2.supply_chains.models.profile import Company

from django.utils import timezone
from django.db.models import Sum

from fairtrace_v2.v2.transactions.serializers.internal import InternalTransactionSerializer

mapping = {
    'CQVLT23004568': [
        '60071090410513025',
        '60071090008678242',
        '60071090008673667',
        '60071090008678754',
        '60071090008673513',
        '60071090008678921',
        '60071090008673964',
        '60071090410513773',
        '60071090008673070',
        '60071090008672950',
        '60071090008678358'],
    'CQVLT23004569': [
        '60071090008674176',
        '60071090008677795',
        '60071090008673766',
        '60071090008673223',
        '60071090410513766',
        '60071090008673995',
        '60071090008673490',
        '60071090008674008',
        '60071090008673629'],
    'CQVLT23004718': [
        '60071090008699360',
        '60071090008692385',
        '60071090008692736',
        '60071090008692910',
        '60071090008699377',
        '60071090008692279',
        '60071090008698936'],
    'CQVLT23004719': [
        '60071090008692460',
        '60071090008692828',
        '60071090008699001',
        '60071090008699322',
        '60071090008693115',
        '60071090008699070',
        '60071090008692286'],
    'CQVLT23004720': [
        '60071090008702176',
        '60071090008701933',
        '60071090008701599'],
    'CQVLT23004721': [
        '60071090008702084',
        '60071090008701957',
        '60071090008701575'],
    'CQVLT23005167': [
        '60071090008711802', 
        '60071090008711413'],
    'CQVLT23005168': [
        '60071090008725168',
        '60071090008724949',
        '60071090008711567'],
    'CQVLT23005169': [
        '60071090901997891',
        '60071090902000231',
        '60071090902000170',
        '60071090901998157',
        '60071090901998829',
        '60071090901998287',
        '60071090901998096',
        '60071090901998737',
        '60071090901998584',
        '60071090901998393',
        '60071090901998973',
        '60071090901997983'],
    'CQVLT23005170': [
        '60071090901999178',
        '60071090901999307',
        '60071090901999031'],
    'CQVLT23005490': [
        '60071090008740994',
        '60071090008740871',
        '60071090008741991',
        '60071090008741359',
        '60071090008742097',
        '60071090008740659',
        '60071090008741557',
        '60071090008741335',
        '60071090008739257',
        '60071090008741786'],
    'CQVLT23005491': [
        '60071090008752614',
        '60071090008752966',
        '60071090008752393',
        '60071090008743124',
        '60071090008742677',
        '60071090008742134',
        '60071090008742974',
        '60071090008753406',
        '60071090008752607'],
    'CQVLT23005492': [
        '60071090008753871'],
    'CQVLT23005830': [
        '60071090008789665', 
        '60071090410778370'],
    'CQVLT23005831': [
        '60071090008798377', 
        '60071090008798636'],
    'CQVLT23005832': [
        '60071090410744672',
        '60071090410743910',
        '60071090410744009',
        '60071090410743347',
        '60071090410744573'],
    'CQVLT23005833': [
        '60071090410743989',
        '60071090410744030',
        '60071090410744559'],
    'CQVLT23005834': [
        '60071090410745433'],
    'CQVLT23005835': [
        '60071090410745518'],
    'CQVLT23005836': [
        '60071090410745860'],
    'CQVLT23005837': [
        '60071090410745136'],
    'CQVLT23005838': [
        '60071090410745952'],
    'CQVLT23005839': [
        '60071090410745754'],
    'CQVLT23005840': [
        '60071090410753834'],
    'CQVLT23005841': [
        '60071090410778912'],
    'CQVLT23006782': [
        '60071090008814848',
        '60071090008810116',
        '60071090008811717',
        '60071090008814886',
        '60071090008810444',
        '60071090008811342',
        '60071090008809103',
        '60071090008814862',
        '60071090008810802',
        '60071090008809660'],
    'CQVLT23006783': [
        '60071090008810949',
        '60071090008811366',
        '60071090008810215',
        '60071090008814855',
        '60071090008810475',
        '60071090008809004',
        '60071090008809677',
        '60071090008814831',
        '60071090008810673',
        '60071090008809752']
                    }

def run():
    c = Company.objects.filter(name__icontains='Dole').first()
    all_batches = Batch.objects.filter(node=c)
    product = Product.objects.filter(name__icontains='Batch').first()
    serializer_klass = InternalTransactionSerializer

    for batch_no, pallets in mapping.items():
        batches = all_batches.filter(buyer_ref_number__in=pallets)
        batch_data = [
            {
            "batch": batch.idencode, 
            "quantity": batch.current_quantity
            } for batch in batches]
        data = {
            "type": 3,
            "created_on": timezone.now(),
            "supply_chain": product.supply_chain.idencode,
            "destination_batches": [
                {
                    "product": product.idencode,
                    "quantity": batches.aaggregate(
                        Sum('current_quantity'))['current_quantity__sum'],
                    "unit": UNIT_KG
                }
            ],
            "source_batches": batch_data}
        
        context = {'user': c.members.last(), 'node': c}
        serializer = serializer_klass(data=data, context=context)
        serializer.is_valid(raise_exception=True)
        serializer.save()

    print('Done')